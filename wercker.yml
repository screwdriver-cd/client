box: golang

build:
  steps:
     # Store the original source dir so we can pass the file to deploy
    - script:
      name: provide chance for deployment
      code: |
        export ORG_SOURCE=$WERCKER_SOURCE_DIR

    - wercker/setup-go-workspace:
      package-dir: github.com/screwdriver-cd/client

    - script:
      name: Install go-swagger
      code: |
        cd $WERCKER_SOURCE_DIR
        cd ../../
        mkdir go-swagger
        pwd
        ls
        cd go-swagger
        git clone https://github.com/go-swagger/go-swagger.git
        cd go-swagger && git checkout tags/0.5.0
      
    - script:
      name: go get
      code: |
        cd $WERCKER_SOURCE_DIR
        go get -t ./...

    - wercker/golint

    - script:
      name: go test
      code: go test ./...

    - script:
      name: go build
      code: |
        go build -a -o go-client
        mv go-client $ORG_SOURCE

deploy:
  steps:
    # Add our deploy key to SSH
    - add-ssh-key:
      keyname: GIT_KEY

    - install-packages:
        packages: openssh-client

    # Add GitHub's SSH fingerprint to SSH known_hosts
    - add-to-known_hosts:
      hostname: github.com
      fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
      type: rsa
